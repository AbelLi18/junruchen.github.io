<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D3 -- 折线图</title>
  <style>
    * {
      box-sizing: border-box;
    }

    p, div {
      padding: 0;
      margin: 0;
    }

    svg {
      border: 1px solid;
    }

    .line-box {
      width: 100%;
      height: 340px;
    }

    .line-demo {
      position: relative;
    }

    .line-tips {
      display: none;
      position: absolute;
      padding: 5px;
      border-radius: 4px;
      min-width: 100px;
      max-width: 200px;
      font-size: 12px;
      background-color: rgba(0, 0, 0, .4);
      color: #fff;
    }

    .tip-content-i {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
      vertical-align: middle;
    }

  </style>
</head>
<body>
<div class="d3-container">
  <div class="line-box">
    <div class="line-demo">
      <div class="line-tips"></div>
    </div>
  </div>
</div>
</body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
  /**
   * 分析：折线图 （包含：线、坐标系、文字）
   * 线：path
   * 文字：text
   * 坐标系：线性
   * */

    // 用户指定
  let paddingT = 40
  let paddingB = 80
  let paddingL = 60
  let paddingR = 40
  let color = ['#5588AA', '#FFBB33', 'red', 'green', 'purple', 'black', '#cccccc']

  let lineData = {
    'title': 'LOAD',
    'legend': ['LOAD'],
    'yAxis': {
      'title': 'GDP'
    },
    'xAxis': {
      'title': '日期',
      'data': ['2017-06-22 17:01:16', '2017-06-22 17:01:36', '2017-06-22 17:01:56', '2017-06-22 17:02:16', '2017-06-22 17:02:36', '2017-06-22 17:02:56', '2017-06-22 17:03:16', '2017-06-22 17:03:36', '2017-06-22 17:03:56', '2017-06-22 17:04:16', '2017-06-22 17:04:36', '2017-06-22 17:04:56', '2017-06-22 17:05:16', '2017-06-22 17:05:36', '2017-06-22 17:05:56', '2017-06-22 17:06:16', '2017-06-22 17:06:36', '2017-06-22 17:06:56', '2017-06-22 17:07:16', '2017-06-22 17:07:36', '2017-06-22 17:07:56', '2017-06-22 17:08:16', '2017-06-22 17:08:36', '2017-06-22 17:08:56', '2017-06-22 17:09:16', '2017-06-22 17:09:36', '2017-06-22 17:09:56', '2017-06-22 17:10:16', '2017-06-22 17:10:36', '2017-06-22 17:10:56', '2017-06-22 17:11:16', '2017-06-22 17:11:36', '2017-06-22 17:11:56', '2017-06-22 17:12:16', '2017-06-22 17:12:36', '2017-06-22 17:12:56', '2017-06-22 17:13:16', '2017-06-22 17:13:36', '2017-06-22 17:13:56', '2017-06-22 17:14:16', '2017-06-22 17:14:36', '2017-06-22 17:14:56', '2017-06-22 17:15:16', '2017-06-22 17:15:36', '2017-06-22 17:15:56', '2017-06-22 17:16:16', '2017-06-22 17:16:36', '2017-06-22 17:16:56', '2017-06-22 17:17:16', '2017-06-22 17:17:36']
    },
    'series': [
      [{'data': 3356, 'time': '2017-06-22 17:01:16'}, {
        'data': 3338,
        'time': '2017-06-22 17:01:36'
      }, {'data': 9646, 'time': '2017-06-22 17:01:56'}, {
        'data': 3379,
        'time': '2017-06-22 17:02:16'
      }, {'data': 7872, 'time': '2017-06-22 17:02:36'}, {
        'data': 6584,
        'time': '2017-06-22 17:02:56'
      }, {'data': 6985, 'time': '2017-06-22 17:03:16'}, {
        'data': 2661,
        'time': '2017-06-22 17:03:36'
      }, {'data': 6921, 'time': '2017-06-22 17:03:56'}, {
        'data': 7087,
        'time': '2017-06-22 17:04:16'
      }, {'data': 4514, 'time': '2017-06-22 17:04:36'}, {
        'data': 9251,
        'time': '2017-06-22 17:04:56'
      }, {'data': 5592, 'time': '2017-06-22 17:05:16'}, {
        'data': 5846,
        'time': '2017-06-22 17:05:36'
      }, {'data': 5508, 'time': '2017-06-22 17:05:56'}, {
        'data': 7787,
        'time': '2017-06-22 17:06:16'
      }, {'data': 3246, 'time': '2017-06-22 17:06:36'}, {
        'data': 8543,
        'time': '2017-06-22 17:06:56'
      }, {'data': 8258, 'time': '2017-06-22 17:07:16'}, {
        'data': 9142,
        'time': '2017-06-22 17:07:36'
      }, {'data': 6821, 'time': '2017-06-22 17:07:56'}, {
        'data': 2585,
        'time': '2017-06-22 17:08:16'
      }, {'data': 35, 'time': '2017-06-22 17:08:36'}, {
        'data': 1300,
        'time': '2017-06-22 17:08:56'
      }, {'data': 4649, 'time': '2017-06-22 17:09:16'}, {
        'data': 2115,
        'time': '2017-06-22 17:09:36'
      }, {'data': 701, 'time': '2017-06-22 17:09:56'}, {
        'data': 9965,
        'time': '2017-06-22 17:10:16'
      }, {'data': 4072, 'time': '2017-06-22 17:10:36'}, {
        'data': 1592,
        'time': '2017-06-22 17:10:56'
      }, {'data': 2367, 'time': '2017-06-22 17:11:16'}, {
        'data': 175,
        'time': '2017-06-22 17:11:36'
      }, {'data': 7757, 'time': '2017-06-22 17:11:56'}, {
        'data': 3794,
        'time': '2017-06-22 17:12:16'
      }, {'data': 1629, 'time': '2017-06-22 17:12:36'}, {
        'data': 4911,
        'time': '2017-06-22 17:12:56'
      }, {'data': 4976, 'time': '2017-06-22 17:13:16'}, {
        'data': 245,
        'time': '2017-06-22 17:13:36'
      }, {'data': 3648, 'time': '2017-06-22 17:13:56'}, {
        'data': 6198,
        'time': '2017-06-22 17:14:16'
      }, {'data': 1248, 'time': '2017-06-22 17:14:36'}, {
        'data': 7314,
        'time': '2017-06-22 17:14:56'
      }, {'data': 1592, 'time': '2017-06-22 17:15:16'}, {
        'data': 1253,
        'time': '2017-06-22 17:15:36'
      }, {'data': 747, 'time': '2017-06-22 17:15:56'}, {
        'data': 6343,
        'time': '2017-06-22 17:16:16'
      }, {'data': 6370, 'time': '2017-06-22 17:16:36'}, {
        'data': 3966,
        'time': '2017-06-22T17:16:56.253123'
      }, {
        'data': 6075, 'time': '2017-06-22 17:17:16'
      }, {'data': 2753, 'time': '2017-06-22 17:17:36'}
      ],
      [{'data': 3256, 'time': '2017-06-22 17:01:16'}, {
        'data': 1338,
        'time': '2017-06-22 17:01:36'
      }, {'data': 4646, 'time': '2017-06-22 17:01:56'}, {
        'data': 6379,
        'time': '2017-06-22 17:02:16'
      }, {'data': 2872, 'time': '2017-06-22 17:02:36'}, {
        'data': 9584,
        'time': '2017-06-22 17:02:56'
      }, {'data': 6385, 'time': '2017-06-22 17:03:16'}, {
        'data': 1661,
        'time': '2017-06-22 17:03:36'
      }, {'data': 2921, 'time': '2017-06-22 17:03:56'}, {
        'data': 3087,
        'time': '2017-06-22 17:04:16'
      }, {'data': 9514, 'time': '2017-06-22 17:04:36'}, {
        'data': 2251,
        'time': '2017-06-22 17:04:56'
      }, {'data': 9592, 'time': '2017-06-22 17:05:16'}, {
        'data': 1846,
        'time': '2017-06-22 17:05:36'
      }, {'data': 9508, 'time': '2017-06-22 17:05:56'}, {
        'data': 2787,
        'time': '2017-06-22 17:06:16'
      }, {'data': 7246, 'time': '2017-06-22 17:06:36'}, {
        'data': 2543,
        'time': '2017-06-22 17:06:56'
      }, {'data': 4258, 'time': '2017-06-22 17:07:16'}, {
        'data': 5142,
        'time': '2017-06-22 17:07:36'
      }, {'data': 6821, 'time': '2017-06-22 17:07:56'}, {
        'data': 1585,
        'time': '2017-06-22 17:08:16'
      }, {'data': 435, 'time': '2017-06-22 17:08:36'}, {
        'data': 6300,
        'time': '2017-06-22 17:08:56'
      }, {'data': 649, 'time': '2017-06-22 17:09:16'}, {
        'data': 3115,
        'time': '2017-06-22 17:09:36'
      }, {'data': 701, 'time': '2017-06-22 17:09:56'}, {
        'data': 4965,
        'time': '2017-06-22 17:10:16'
      }, {'data': 4072, 'time': '2017-06-22 17:10:36'}, {
        'data': 5592,
        'time': '2017-06-22 17:10:56'
      }, {'data': 5367, 'time': '2017-06-22 17:11:16'}, {
        'data': 2875,
        'time': '2017-06-22 17:11:36'
      }, {'data': 1757, 'time': '2017-06-22 17:11:56'}, {
        'data': 9794,
        'time': '2017-06-22 17:12:16'
      }, {'data': 2629, 'time': '2017-06-22 17:12:36'}, {
        'data': 6911,
        'time': '2017-06-22 17:12:56'
      }, {'data': 3976, 'time': '2017-06-22 17:13:16'}, {
        'data': 2245,
        'time': '2017-06-22 17:13:36'
      }, {'data': 9648, 'time': '2017-06-22 17:13:56'}, {
        'data': 2198,
        'time': '2017-06-22 17:14:16'
      }, {'data': 7248, 'time': '2017-06-22 17:14:36'}, {
        'data': 7014,
        'time': '2017-06-22 17:14:56'
      }, {'data': 1992, 'time': '2017-06-22 17:15:16'}, {
        'data': 5253,
        'time': '2017-06-22 17:15:36'
      }, {'data': 2747, 'time': '2017-06-22 17:15:56'}, {
        'data': 3343,
        'time': '2017-06-22 17:16:16'
      }, {'data': 4370, 'time': '2017-06-22 17:16:36'}, {
        'data': 5966,
        'time': '2017-06-22T17:16:56.253123'
      }, {
        'data': 4075, 'time': '2017-06-22 17:17:16'
      }, {'data': 8753, 'time': '2017-06-22 17:17:36'}
      ]
    ]
  }

  // 全局变量
  let width = parseInt(d3.select('.line-box').style('width'))
  let height = parseInt(d3.select('.line-box').style('height'))
  let lineWidth = width - paddingL - paddingR
  let lineHeight = height - paddingT - paddingB
  let svg = d3.select('.line-demo')
    .append('svg')
    .attr('width', width)
    .attr('height', height)
  let xScale = d3.scaleTime()
  let yScale = d3.scaleLinear()

  media() // 自适应处理
  drawLine() // 画图
  mousemove() // 控制tip

  function drawLine () {
    drawLabel() // 绘制legend
    drawAxis() // 绘制坐标系
    drawArea() //绘制路径背景 -----> 动画有问题
    drawPath() // 绘制路径
    drawCircle() // 绘制圆点
  }

  function drawLabel () {
    // legend
    let legendG = svg.selectAll('.legend').data(lineData.legend)
    let enterLabel = legendG.enter().append('g')

    legendG.selectAll('text')
      .text((d) => {
        return d
      })

    enterLabel
      .attr('class', 'legend')
      .append('rect')
      .attr('width', '23')
      .attr('height', '13')
      .attr('stroke-width', 0)
      .attr('fill', (d, i) => {
        return color[i]
      })
      .attr('x', (d, i) => {
        return paddingL + i * 80
      })
      .attr('y', lineHeight + paddingT + 40)
      .attr('rx', '2')
    enterLabel.append('text')
      .attr('x', (d, i) => {
        return paddingL + i * 80
      })
      .attr('y', lineHeight + paddingT + 40)
      .attr('dx', '28')
      .attr('dy', '.5rem')
      .attr('font-size', '12')
      .attr('text-anthor', 'middle')
      .attr('stroke-width', 0)
      .text((d) => {
        return d
      })

    // del
    legendG.exit().remove()

  }
  function drawAxis () {
    // 绘制坐标系

    xScale.domain([new Date(d3.min(lineData.xAxis.data)), new Date(d3.max(lineData.xAxis.data))])
      .range([0, lineWidth])

    let xAxis = d3.axisBottom(xScale)
      .ticks(5)
      .tickFormat(d3.timeFormat('%Y-%m-%d %H:%M:%S'))

    let gXaxis = svg.select('.xAxis')
      .call(xAxis)
      .attr('transform', 'translate(' + paddingL + ',' + (height - paddingB) + ')')

    if (gXaxis.size() === 0) {
      gXaxis = svg.append('g')
        .call(xAxis)
        .attr('class', 'xAxis')
        .attr('transform', 'translate(' + paddingL + ',' + (height - paddingB) + ')')
        .append('text')
        .text(lineData.xAxis.title)
        .attr('stroke-width', 0)
        .attr('fill', 'black')
        .attr('transform', 'translate(' + lineWidth + ', 0)')
        .attr('dx', '1rem')
    }

    let maxData = getMax()
    yScale.domain([0, maxData])
      .range([lineHeight, 0])
    let yAxis = d3.axisLeft()
      .scale(yScale)
      .ticks(5)
    let gYaxis = svg.select('.yAxis')
      .call(yAxis)
      .attr('transform', 'translate(' + paddingL + ',' + paddingT + ')')

    if (gYaxis.size() === 0) {
      gYaxis = svg.append('g')
        .call(yAxis)
        .attr('class', 'yAxis')
        .attr('transform', 'translate(' + paddingL + ',' + paddingT + ')')
        .append('text')
        .text(lineData.yAxis.title)
        .attr('stroke-width', 0)
        .attr('fill', 'black')
        .attr('text-anthor', 'middle')
    }
  }
  function drawPath () {
    let line = d3.line()
      .x((d) => {
        return xScale(new Date(d.time))
      })
      .y((d) => {
        return yScale(d.data) + paddingT
      })
    let path = svg.selectAll('.line-path').data(lineData.series)
    let enterPath = path.enter()
    // update
    path
      .attr('d', (d) => {
        return line(d)
      })
      .attr('stroke-dasharray', function () {
        return this.getTotalLength()
      })
      .attr('stroke-dashoffset', function () {
        let lastOffSet = d3.select(this).attr('data-offset')
        d3.select(this).attr('data-offset', this.getTotalLength())
        let newOffSet = this.getTotalLength() - lastOffSet
        return newOffSet > 0 ? newOffSet : 0
      })
      .transition()
      .duration(500)
      .attr('stroke-dashoffset', 0)

    enterPath.append('path').attr('class', 'line-path')
      .attr('d', (d) => {
        return line(d)
      })
      .attr('stroke', function (d, i) {
        return color[i]
      })
      .attr('fill', 'none')
      .attr('transform', 'translate(' + paddingL + ')')
      .attr('stroke-dasharray', function () {
        d3.select(this).attr('data-offset', this.getTotalLength())
        return this.getTotalLength()
      })
      .attr('stroke-dashoffset', function () {
        return this.getTotalLength()
      })
      .transition()
      .duration(1000)
      .attr('stroke-dashoffset', 0)

    // del
    path.exit().remove()
  }
  function drawArea () {
    let areaLine = d3.area()
      .x((d) => {
        return xScale(new Date(d.time))
      })
      .y0(() => {
        return height - paddingB
      })
      .y1((d) => {
        return yScale(d.data) + paddingT
      })

    let areaPath = svg.selectAll('.line-areapath').data(lineData.series)
    let enterAreaPath = areaPath.enter()

    // update
    areaPath
      .attr('d', (d) => {
        return areaLine(d)
      })

    // add
    enterAreaPath.append('path').attr('class', 'line-areapath')
      .attr('d', (d) => {
        return areaLine(d)
      })
      .attr('stroke', 'none')
      .attr('fill', (d, i) => {
        return color[i]
      })
      .attr('fill-opacity', '.3')
      .attr('transform', 'translate(' + paddingL + ')')
    enterAreaPath.append('rect')
      .attr('class', 'path-area-mark')
      .attr('width', lineWidth)
      .attr('height', lineHeight)
      .attr('x', paddingL + 1)
      .attr('y', paddingT)
      .attr('fill', '#fff')
      .attr('transform-origin', 'right center')
      .transition()
      .duration(1000)
      .attr('transform', 'scale(0, 1)')

    // del
    areaPath.exit().remove()
  }
  function drawCircle () {
    let circleG = svg.selectAll('.line-circle')
      .data(lineData.series)
    let enterCircleG = circleG.enter()

    // add
    enterCircleG.append('g')
      .attr('class', 'line-circle')
      .attr('id', (d, i) => {
        return 'line-circle' + i
      })
      .attr('transform', 'translate(' + paddingL + ', ' + paddingT + ')')
      .attr('fill', (d, i) => {
        return color[i]
      })
    // del
    circleG.exit().remove()

    lineData.series.forEach((item, idx) => {
      let parentG = svg.selectAll('#line-circle' + idx)
      circle(item, parentG)
    })
  }
  function circle (data, circleG) {
    let circle = circleG.selectAll('circle')
      .data(data)
    let enterCircle = circle.enter()

    // update
    circle
      .attr('cx', (d) => {
        return xScale(new Date(d.time))
      })
      .attr('cy', (d) => {
        return yScale(d.data)
      })
    // add
    enterCircle
      .append('circle')
      .attr('cx', (d) => {
        return xScale(new Date(d.time))
      })
      .attr('cy', (d) => {
        return yScale(d.data)
      })
      .attr('r', 3.5)
      .style('cursor', 'pointer')
      .on('mouseover', function () {
        d3.select(this).transition().duration(100).attr('r', 5)
      })
      .on('mouseout', function () {
        d3.select(this).transition().duration(50).attr('r', 3.6)
      })
      .attr('fill-opacity', 0)
      .transition()
      .duration(1000)
      .attr('fill-opacity', 1)
    // del
    circle.exit().remove()
  }

  function mousemove () {
    let tipsRect = svg.append('rect')
      .attr('class', 'mousemove-rect')
      .attr('width', lineWidth)
      .attr('height', lineWidth)
      .attr('x', paddingL)
      .attr('y', paddingT)
      .attr('fill', 'none')
      .style('pointer-events', 'all')
      .on('mouseover', function () {
        d3.select('.line-tips').transition().duration(200).style('display', 'block')
        d3.select('.verline-tips-group').transition().duration(200).style('display', 'block')
      })
      .on('mouseout', function () {
        d3.select('.line-tips').transition().duration(100).style('display', 'none')
        d3.select('.verline-tips-group').transition().duration(200).style('display', 'none')
      })
      .on('mousemove', drawTip)
  }
  function drawTip () {
    var bisect = d3.bisector(function (d) {
      return new Date(d)
    }).left

    // 获取x轴坐标
    let x0 = xScale.invert(d3.mouse(this)[0] - paddingL),
      i = bisect(lineData.xAxis.data, x0),
      d0 = lineData.xAxis.data[i - 1],
      d1 = lineData.xAxis.data[i],
      d = new Date((x0 - d0) > (d1 - x0) ? d1 : d0)

    // 获取交点 y轴坐标
    let points = []
    lineData.series.forEach((item) => {
      item.forEach((ditem) => {
        if (Date.parse(ditem.time) === Date.parse(d)) {
          points.push(ditem.data)
        }
      })
    })

    // 绘制垂直线以及圆点
    let tipsLine = d3.selectAll('.verline-tips-group')
    tipsLine.selectAll('.verline-tips').attr('x1', xScale(d) + paddingL)
      .attr('x2', xScale(d) + paddingL)
    if (tipsLine.size() === 0) {
      svg.append('g')
        .attr('class', 'verline-tips-group')
        .append('line')
        .attr('class', 'verline-tips')
        .attr('x1', xScale(d))
        .attr('y1', paddingT)
        .attr('x2', xScale(d))
        .attr('y2', height - paddingB)
        .attr('stroke', '#999')
        .on('mouseover', function () {
          d3.select('.line-tips').transition().duration(200).style('display', 'block')
          d3.select('.verline-tips-group').transition().duration(200).style('display', 'block')
        })
        .on('mouseout', function () {
          d3.select('.line-tips').transition().duration(100).style('display', 'block')
          d3.select('.verline-tips-group').transition().duration(200).style('display', 'block')
        })
    }
    let tipsLineCircle = tipsLine.selectAll('.verline-tips-circle').data(points)
    tipsLineCircle
      .attr('cx', xScale(d) + paddingL)
      .attr('cy', (d) => {
        return yScale(d) + paddingT
      })
    let enterTipsLineCircle = tipsLineCircle.enter()
    enterTipsLineCircle.append('circle')
      .attr('class', 'verline-tips-circle')
      .attr('r', 5)
      .attr('cx', xScale(d) + paddingL)
      .attr('cy', (d) => {
        return yScale(d) + paddingT
      })
      .attr('fill', (d, i) => {
        return color[i]
      })
      .on('mouseover', function () {
        d3.select('.line-tips').transition().duration(200).style('display', 'block')
        d3.select('.verline-tips-group').transition().duration(200).style('display', 'block')
      })
      .on('mouseout', function () {
        d3.select('.line-tips').transition().duration(100).style('display', 'block')
        d3.select('.verline-tips-group').transition().duration(200).style('display', 'block')
      })
    tipsLineCircle.exit().remove()

    // tip框填充相应文字数据
    let timeFormat = d3.timeFormat('%Y-%m-%d %H:%M:%S')
    let tips = d3.select('.line-tips')
    let tipsTitle = tips.selectAll('.tip-title')
    tipsTitle.text('时间: ' + timeFormat(d))
    if (tipsTitle.size() === 0) {
      tips.append('p')
        .attr('class', 'tip-title')
        .text('时间: ' + timeFormat(d))
    }
    let tipsPoint = tips.selectAll('.tip-content').data(points)
    tipsPoint.select('span')
      .text((d, i) => {
        return lineData.legend[i] + ' 数据: ' + d
      })

    let enterTipsPoint = tipsPoint.enter()
    let tipsPointDiv = enterTipsPoint
      .append('div')
      .attr('class', 'tip-content')
    tipsPointDiv.append('i')
      .attr('class', 'tip-content-i')
      .style('background-color', (d, i) => {
        return color[i]
      })
    tipsPointDiv.append('span')
      .text((d, i) => {
        return lineData.legend[i] + ' 数据: ' + d
      })
    tipsPoint.exit().remove()

    // tip框位置处理 边界处理
    let svgCenterW = width / 2, svgCenterH = height / 2, tipsL, tipsT
    if (d3.mouse(this)[0] > svgCenterW) {
      tipsL = d3.mouse(this)[0] - parseInt(tips.style('width')) - 20 + 'px'
    } else {
      tipsL = d3.mouse(this)[0] + 20 + 'px'
    }
    if (d3.mouse(this)[1] > svgCenterH) {
      tipsT = d3.mouse(this)[1] - parseInt(tips.style('height')) - 20 + 'px'
    } else {
      tipsT = d3.mouse(this)[1] + 20 + 'px'
    }
    tips.style('left', tipsL)
      .style('top', tipsT)
  }

  function media () {
    window.onresize = function () {
      width = document.body.clientWidth
      lineWidth = width - paddingL - paddingR
      svg.attr('width', width)
      drawLine()
    }
  }

  // 方法
  function getMax () {
    let maxData = []
    lineData.series.forEach((item, idx) => {
      let itemMax = d3.max(item, (d) => {
        return d.data
      })
      maxData.push(itemMax)
    })
    return d3.max(maxData)
  }

</script>
</html>
